<?xml version="1.0" encoding="UTF-8" ?>

<!--
This file is part of JavaSMT,
an API wrapper for a collection of SMT solvers:
https://github.com/sosy-lab/java-smt

SPDX-FileCopyrightText: 2025 Dirk Beyer <https://www.sosy-lab.org>

SPDX-License-Identifier: Apache-2.0
-->

<!-- vim: set tabstop=8 shiftwidth=4 expandtab sts=4 filetype=ant fdm=marker: -->
<project name="publish-solvers-z3-legacy-3.5.0" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">

    <import file="macros.xml"/>

    <property name="z3legacy.dist.dir" value="${ivy.solver.dist.dir}/z3legacy"/>
    <property name="z3legacy.project.name" value="Java Bindings for Z3 legacy"/>

    <target name="check-z3-legacy-path">
        <fail unless="z3.path">
            INFO
            Please specify the path to Z3 legacy 3.5.0 sources directory with the flag '-Dz3.path=/path/to/z3'.
            The path should contain directories like './build/', and should be absolute.
            Please provide the built legacy Z3 version in this path.
            Currently only a Linux x64 version for Z3 legacy is available. 
            This script does not expect other z3-related files or directories in the parent directory.
            For example, the directory structure can look like this:

            z3/                                // &lt;-- parent directory and target of 'z3.path'
             |--build
                |-- libz3legacy.so     
                |-- ...             

            This can be achieved by following the steps in '/lib/native/source/z3-4.5.0/README.md'.
        </fail>
    </target>

    <target name="check-z3-legacy-version">
        <fail unless="z3.legacy.version">
            INFO
            Please specify the version string used for Z3 legacy with the flag '-Dz3.legacy.version=SOME_VERSION'.
            Usually this should just be '4.5.0', but changes might need an updated name.
        </fail>
    </target>

    <target name="package-z3-legacy" depends="check-z3-legacy-path,check-z3-legacy-version">
        <!-- collect all files -->
        <copy todir="${z3legacy.dist.dir}/" flatten="true" verbose="true">
            <fileset dir="${z3.path}/build/">
                <include name="com.microsoft.z3legacy.jar"/>
                <include name="libz3*.so"/>

            </fileset>
        </copy>
        <!-- There is no ARM release for the legacy version -->
        <!-- TODO: add Windows and MacOS releases -->

        <!-- check for properties of Z3 for Linux -->
        <exec executable="readelf" dir="./" outputproperty="z3.elf_details" logError="true" failonerror="true">
            <arg value="-d"/>
            <arg value="${z3legacy.dist.dir}/libz3legacy.so"/>
        </exec>
        <fail>
            <condition>
                <not><contains string="${z3.elf_details}" substring="(SONAME)"/></not>
            </condition>
            libz3legacy.so has missing SONAME property.
            Please run 'patchelf --set-soname libz3legacy.so ${z3.path}/build/libz3legacy.so'.
        </fail>

        <!-- Linux files -->
        <move file="${z3legacy.dist.dir}/libz3legacy.so" tofile="${z3legacy.dist.dir}/libz3legacy-${z3.legacy.version}.so" verbose="true"/>
        <move file="${z3legacy.dist.dir}/libz3javalegacy.so" tofile="${z3legacy.dist.dir}/libz3javalegacy-${z3.legacy.version}.so" verbose="true"/>
        <!-- There is no ARM/Windows/MacOS release for the legacy version currently -->
        <!-- common Java file, Java is platform independent -->
        <move file="${z3legacy.dist.dir}/com.microsoft.z3legacy.jar" tofile="${z3legacy.dist.dir}/com.microsoft.z3legacy-${z3.legacy.version}.jar"/>
    </target>

    <target name="publish-z3-legacy" depends="package-z3-legacy, load-ivy"
        description="Publish Z3 legacy binaries to Ivy repo.">
        <ivy:resolve conf="solver-z3-legacy,solver-z3-legacy-x64" file="solvers_ivy_conf/ivy_z3-legacy.xml"/>
        <publishToRepository solverName="Z3-legacy" solverVersion="${z3.legacy.version}" distDir="${z3legacy.dist.dir}"/>

        <!--
          We additionally provide x64-files without arch-attribute for backwards compatibility,
          such that applications can load dependencies without changing their Ivy configuration.
          Those files are not part of any direct configuration, but will be resolved if the
          arch-attribute is not used.
        -->
        <echo>
            Lets copy the files for architecture x64 into main directory, for backwards compatibility.
            Afterward, please execute the SVN command from above.
        </echo>
        <copy todir="repository/${ivy.organisation}/${ivy.module}/" verbose="true">
            <fileset dir="repository/${ivy.organisation}/${ivy.module}/x64/">
                <include name="*-${z3.legacy.version}.*"/>
            </fileset>
        </copy>
    </target>
</project>
