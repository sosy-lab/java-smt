<?xml version="1.0" encoding="UTF-8" ?>

<!--
This file is part of JavaSMT,
an API wrapper for a collection of SMT solvers:
https://github.com/sosy-lab/java-smt

SPDX-FileCopyrightText: 2024 Dirk Beyer <https://www.sosy-lab.org>

SPDX-License-Identifier: Apache-2.0
-->

<!-- vim: set tabstop=8 shiftwidth=4 expandtab sts=4 filetype=ant fdm=marker: -->
<project name="publish-solvers-bitwuzla" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">

    <property name="bitwuzla.buildForLinux" value="true"/>
    <property name="bitwuzla.buildForWindows" value="true"/>

    <import file="macros.xml"/>

    <!-- This file is split into several parts:
    * Target build-bitwuzla checks that all required options were used on the command line.
      We need the paths to gmp and the Bitwuzla source, along with an option that specified which
      version tag to use with the compiled binaries. In addition, we require the user to specify
      whether the JNI bindings should be recreated or not. This step is necessary if the API of
      Bitwuzla has changed since the last release, but it requires SWIG >=4.1 to be installed on the
      local machine.
    * If the flag -Dbitwuzla.rebuildWrapper is enabled, we execute SWIG to automatically generate
      Java bindings for Bitwuzla from our SWIG interface script. The bindings are then patched to
      handle some phantom reference issues, and to add copyright headers to all generated files.
    * The target package-bitwuzla compiles the autogenerated JNI code and then packages the
      library files.
    -->

    <target name="set-properties-for-bitwuzla">
        <checkPathOption pathOption="bitwuzla.path" defaultPath="/path/to/bitwuzla" targetName="Bitwuzla source folder (git checkout from 'https://github.com/bitwuzla/bitwuzla)"/>
        <checkPathOption pathOption="jdk-windows.path" defaultPath="/path/to/jdk" targetName="JDK source folder (Windows version)"/>
        <fail unless="bitwuzla.customRev">
            Please specify a custom revision with the flag -Dbitwuzla.customRev=XXX.
            The custom revision should be a version number of Bitwuzla.
            The script will append the git revision.
        </fail>
        <fail unless="bitwuzla.rebuildWrapper">
            Please specify if the Bitwuzla wrapper should be rebuild with the flag
            -Dbitwuzla.rebuildWrapper=BOOL. Rebuilding the wrapper is necessary if the Bitwuzla API
            has changed since the last release, but requires the SWIG tool to be installed on
            this machine.
        </fail>

        <!-- get a naive version -->
        <exec executable="git" dir="${bitwuzla.path}" outputproperty="bitwuzla.revision"
              failonerror="true">
            <arg value="show"/>
            <arg value="-s"/>
            <arg value="--format=%h"/>
        </exec>

        <!-- set properties for the next steps -->
        <property name="bitwuzla.version" value="${bitwuzla.customRev}-g${bitwuzla.revision}"/>
        <property name="bitwuzla.installPath" location="${bitwuzla.path}/install"/>
        <property name="source.path" location="lib/native/source/libbitwuzla"/>
        <property name="source.installPathLinux" location="${source.path}/install-linux"/>
        <property name="source.installPathWindows" location="${source.path}/install-windows"/>

        <!-- cleanup target directories, will be created and filled during the build-process -->
        <delete dir="${source.installPathLinux}" quiet="true"/>
        <delete dir="${source.installPathWindows}" quiet="true"/>
        <delete dir="${source.path}/build" quiet="true"/>
        <delete dir="${source.path}/doc" quiet="true"/>
        <delete dir="${source.path}/install" quiet="true"/>
    </target>

    <target name="compile-bitwuzla-linux" if="${bitwuzla.buildForLinux}"
            depends="set-properties-for-bitwuzla">
        <delete dir="${bitwuzla.installPath}" quiet="true"/>
        <echo message="Building Bitwuzla in version '${bitwuzla.version}' for Linux"/>

        <!-- configure and build Bitwuzla -->
        <exec executable="./configure.py" dir="${bitwuzla.path}" failonerror="true">
            <arg value="--static"/>
            <arg value="--wipe"/>
            <arg value="--prefix"/>
            <arg value="${bitwuzla.installPath}"/>
        </exec>
        <exec executable="ninja" dir="${bitwuzla.path}/build/" failonerror="true">
            <arg value="install"/>
        </exec>

        <!-- copy Bitwuzla include files to JavaSMT -->
        <copy todir="${source.installPathLinux}">
            <fileset dir="${bitwuzla.installPath}"/>
        </copy>
    </target>

    <target name="compile-bitwuzla-windows" if="${bitwuzla.buildForWindows}"
            depends="set-properties-for-bitwuzla">
        <delete dir="${bitwuzla.installPath}" quiet="true"/>
        <echo message="Building Bitwuzla in version '${bitwuzla.version}' for Windows"/>

        <!-- configure and build Bitwuzla -->
        <exec executable="./configure.py" dir="${bitwuzla.path}" failonerror="true">
            <arg value="--win64"/>
            <arg value="--static"/>
            <arg value="--wipe"/>
            <arg value="--prefix"/>
            <arg value="${bitwuzla.installPath}"/>
        </exec>
        <exec executable="ninja" dir="${bitwuzla.path}/build/" failonerror="true">
            <arg value="install"/>
        </exec>

        <!-- copy Bitwuzla include files to JavaSMT -->
        <copy todir="${source.installPathWindows}">
            <fileset dir="${bitwuzla.installPath}"/>
        </copy>
    </target>

    <!-- Run swig to generate a new wrapper. Only executed if rebuildWrapper was specified. -->
    <!-- Depends on build-bitwuzla for generating the API files. -->
    <target name="build-wrapper" if="${bitwuzla.rebuildWrapper}"
            depends="compile-bitwuzla-linux, compile-bitwuzla-windows">
        <fail unless="bitwuzla.buildForLinux">
            This ant-step uses the Linux dependencies for building the SWIG-wrapper.
            The Windows dependencies are identical and would also work.
        </fail>

        <!-- create output directory for the swig proxies -->
        <delete dir="${source.path}/src" quiet="true"/>
        <mkdir dir="${source.path}/src/org/sosy_lab/java_smt/solvers/bitwuzla/api"/>

        <!-- run swig to generate java files and the c wrapper -->
        <exec executable="swig" dir="${source.path}" failonerror="true">
            <arg value="-java"/>
            <arg value="-c++"/>
            <arg value="-I${source.installPathLinux}"/>
            <arg value="-package"/>
            <arg value="org.sosy_lab.java_smt.solvers.bitwuzla.api"/>
            <arg value="-outdir"/>
            <arg value="src/org/sosy_lab/java_smt/solvers/bitwuzla/api"/>
            <arg value="-o"/>
            <arg value="bitwuzla_wrap.cpp"/>
            <arg value="bitwuzla.i"/>
        </exec>

        <!-- apply patch for the phantom reference issue -->
        <!-- FIXME: This will lead to memory leaks. We should look for a proper fix. -->
        <!-- Update: the TermManger introduced in 0.4.0 handles memory of Terms/Sorts 
             now and should clean up everything when we destroy it. -->
        <exec executable="patch" failonerror="true">
            <arg value="-p0"/>
            <arg value="--no-backup-if-mismatch"/>
            <arg value="-i"/>
            <arg value="lib/native/source/libbitwuzla/swigWrapper.patch"/>
        </exec>
    </target>

    <target name="build-bitwuzla-bindings-jni"
            depends="compile-bitwuzla-linux, compile-bitwuzla-windows, build-wrapper">
    <!-- compile java proxies and create jar file -->
        <mkdir dir="${source.path}/build"/>
        <javac release="11" srcdir="${source.path}/src/" destdir="${source.path}/build" includeantruntime="false" failonerror="true">
            <include name="org/sosy_lab/java_smt/solvers/bitwuzla/api/*.java"/>
        </javac>
        <jar destfile="bitwuzla-${bitwuzla.version}.jar" basedir="${source.path}/build"/>

        <!-- generate and package javadoc documentation -->
        <mkdir dir="${source.path}/doc"/>
        <javadoc sourcepath="${source.path}/src" destdir="${source.path}/doc"/>
        <jar destfile="bitwuzla-${bitwuzla.version}-javadoc.jar" basedir="${source.path}/doc"/>

        <!-- package swig generated source code -->
        <jar destfile="bitwuzla-${bitwuzla.version}-sources.jar" basedir="${source.path}/src"/>
    </target>

    <target name="build-bitwuzla-bindings-linux" if="${bitwuzla.buildForLinux}"
            depends="build-bitwuzla-bindings-jni">
        <!-- compile the swig wrapper -->
        <exec executable="g++" dir="${source.path}" failonerror="true">
            <arg value="-fPIC"/>
            <arg value="-c"/>
            <arg value="bitwuzla_wrap.cpp"/>
            <arg value="-I${source.path}/include"/>
            <arg value="-I${source.installPathLinux}/include"/>
            <arg value="-I${java.home}/include"/>
            <arg value="-I${java.home}/include/linux"/>
        </exec>

        <!-- link the wrapper to create libbitwuzlaJNI.so -->
        <!-- Licensing:
             GMP is licensed under LGPL:
              - https://www.gnu.org/licenses/lgpl-3.0.html
             Bitwuzla is licensed under MIT license:
              - https://github.com/bitwuzla/bitwuzla/blob/main/COPYING
             Based on that information, we provide the whole library including its dependencies under the MIT license.
        -->
        <exec executable="g++" dir="${source.path}" failonerror="true">
            <arg value="-shared"/>
            <arg value="-o"/>
            <arg value="libbitwuzlaj.so"/>
            <arg value="bitwuzla_wrap.o"/>
            <arg value="-Wl,--whole-archive"/>
            <arg value="${source.installPathLinux}/lib/x86_64-linux-gnu/libbitwuzla.a"/>
            <arg value="${source.installPathLinux}/lib/x86_64-linux-gnu/libbitwuzlabb.a"/>
            <arg value="${source.installPathLinux}/lib/x86_64-linux-gnu/libbitwuzlabv.a"/>
            <arg value="${source.installPathLinux}/lib/x86_64-linux-gnu/libbitwuzlals.a"/>
            <arg value="${source.installPathLinux}/lib/x86_64-linux-gnu/libgmp.a"/>
            <arg value="${source.installPathLinux}/lib/x86_64-linux-gnu/libgmpxx.a"/>
            <arg value="-Wl,--no-whole-archive,--allow-multiple-definition"/>
            <arg value="-Wl,-z,defs"/>
        </exec>
    </target>

    <target name="build-bitwuzla-bindings-windows" if="${bitwuzla.buildForWindows}"
            depends="build-bitwuzla-bindings-jni">
        <!-- compile the swig wrapper -->
        <exec executable="x86_64-w64-mingw32-g++" dir="${source.path}" failonerror="true">
            <arg value="-std=c++17"/>
            <arg value="-fPIC"/>
            <arg value="-c"/>
            <arg value="bitwuzla_wrap.cpp"/>
            <arg value="-I${source.path}/include"/>
            <arg value="-I${source.installPathWindows}/include"/>
            <arg value="-I${jdk-windows.path}/include"/>
            <arg value="-I${jdk-windows.path}/include/win32"/>
        </exec>

        <!-- link the wrapper to create libbitwuzlaj.so -->
        <!-- Note:
             libwinpthread is required when using mingw-posix-threads.
             We do not want to install mingw or cygwin on the target-system.
        -->
        <!-- Licensing:
             GCC-based libgcc and libstd++ is licensed under GPL,
             with an explicit allowance for combining with non-GPL-libraries:
              - https://www.gnu.org/licenses/gcc-exception-3.1-faq.en.html
              - https://gcc.gnu.org/onlinedocs/libstdc++/manual/license.html
             Winpthreads is licensed under MIT:
              - https://sourceforge.net/p/mingw-w64/mingw-w64/ci/master/tree/mingw-w64-libraries/winpthreads/COPYING
             GMP is licensed under LGPL:
              - https://www.gnu.org/licenses/lgpl-3.0.html
             Bitwuzla is licensed under MIT license:
              - https://github.com/bitwuzla/bitwuzla/blob/main/COPYING
             Based on that information, we provide the whole library including its dependencies under the MIT license.
        -->
        <exec executable="x86_64-w64-mingw32-g++" dir="${source.path}" failonerror="true">
            <arg value="-std=c++17"/>
            <arg value="-shared"/>
            <arg value="-o"/>
            <arg value="libbitwuzlaj.dll"/>
            <arg value="bitwuzla_wrap.o"/>
            <arg value="-Wl,--whole-archive"/>
            <arg value="/usr/x86_64-w64-mingw32/lib/libwinpthread.a"/>
            <arg value="${source.installPathWindows}/lib/libgmp.a"/>
            <arg value="${source.installPathWindows}/lib/libgmpxx.a"/>
            <arg value="${source.installPathWindows}/lib/libbitwuzlabb.a"/>
            <arg value="${source.installPathWindows}/lib/libbitwuzlabv.a"/>
            <arg value="${source.installPathWindows}/lib/libbitwuzlals.a"/>
            <arg value="${source.installPathWindows}/lib/libbitwuzla.a"/>
            <arg value="-Wl,--no-whole-archive"/>
            <arg value="-static-libgcc"/>
            <arg value="-static-libstdc++"/>
            <arg value="-lpsapi"/>
            <arg value="-Wl,--allow-multiple-definition"/>
        </exec>
    </target>

    <target name="build-bitwuzla-linux" if="${bitwuzla.buildForLinux}"
            depends="compile-bitwuzla-linux, build-wrapper, build-bitwuzla-bindings-linux">
    </target>

    <target name="build-bitwuzla-windows" if="${bitwuzla.buildForWindows}"
            depends="compile-bitwuzla-windows, build-wrapper, build-bitwuzla-bindings-windows">
    </target>

    <target name="publish-bitwuzla"
            depends="build-bitwuzla-linux, build-bitwuzla-windows, load-ivy"
            description="Publish Bitwuzla binaries to Ivy repository.">
        <!-- copy library files into directory to be published for Ivy -->
        <move file="${source.path}/libbitwuzlaj.so" tofile="libbitwuzlaj-${bitwuzla.version}.so" failonerror="true"/>
        <move file="${source.path}/libbitwuzlaj.dll" tofile="libbitwuzlaj-${bitwuzla.version}.dll" failonerror="true"/>

        <ivy:resolve conf="solver-bitwuzla" file="solvers_ivy_conf/ivy_bitwuzla.xml"/>
        <publishToRepository solverName="Bitwuzla" solverVersion="${bitwuzla.version}"/>
    </target>
</project>